<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>README Preview</title>
    <link rel="stylesheet" href="https://github.githubassets.com/assets/github-markdown.css">
    <style>
        body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #49483e }
.highlight { background: #272822; color: #F8F8F2 }
.highlight .c { color: #959077 } /* Comment */
.highlight .err { color: #ED007E; background-color: #1E0010 } /* Error */
.highlight .esc { color: #F8F8F2 } /* Escape */
.highlight .g { color: #F8F8F2 } /* Generic */
.highlight .k { color: #66D9EF } /* Keyword */
.highlight .l { color: #AE81FF } /* Literal */
.highlight .n { color: #F8F8F2 } /* Name */
.highlight .o { color: #FF4689 } /* Operator */
.highlight .x { color: #F8F8F2 } /* Other */
.highlight .p { color: #F8F8F2 } /* Punctuation */
.highlight .ch { color: #959077 } /* Comment.Hashbang */
.highlight .cm { color: #959077 } /* Comment.Multiline */
.highlight .cp { color: #959077 } /* Comment.Preproc */
.highlight .cpf { color: #959077 } /* Comment.PreprocFile */
.highlight .c1 { color: #959077 } /* Comment.Single */
.highlight .cs { color: #959077 } /* Comment.Special */
.highlight .gd { color: #FF4689 } /* Generic.Deleted */
.highlight .ge { color: #F8F8F2; font-style: italic } /* Generic.Emph */
.highlight .ges { color: #F8F8F2; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #F8F8F2 } /* Generic.Error */
.highlight .gh { color: #F8F8F2 } /* Generic.Heading */
.highlight .gi { color: #A6E22E } /* Generic.Inserted */
.highlight .go { color: #66D9EF } /* Generic.Output */
.highlight .gp { color: #FF4689; font-weight: bold } /* Generic.Prompt */
.highlight .gs { color: #F8F8F2; font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #959077 } /* Generic.Subheading */
.highlight .gt { color: #F8F8F2 } /* Generic.Traceback */
.highlight .kc { color: #66D9EF } /* Keyword.Constant */
.highlight .kd { color: #66D9EF } /* Keyword.Declaration */
.highlight .kn { color: #FF4689 } /* Keyword.Namespace */
.highlight .kp { color: #66D9EF } /* Keyword.Pseudo */
.highlight .kr { color: #66D9EF } /* Keyword.Reserved */
.highlight .kt { color: #66D9EF } /* Keyword.Type */
.highlight .ld { color: #E6DB74 } /* Literal.Date */
.highlight .m { color: #AE81FF } /* Literal.Number */
.highlight .s { color: #E6DB74 } /* Literal.String */
.highlight .na { color: #A6E22E } /* Name.Attribute */
.highlight .nb { color: #F8F8F2 } /* Name.Builtin */
.highlight .nc { color: #A6E22E } /* Name.Class */
.highlight .no { color: #66D9EF } /* Name.Constant */
.highlight .nd { color: #A6E22E } /* Name.Decorator */
.highlight .ni { color: #F8F8F2 } /* Name.Entity */
.highlight .ne { color: #A6E22E } /* Name.Exception */
.highlight .nf { color: #A6E22E } /* Name.Function */
.highlight .nl { color: #F8F8F2 } /* Name.Label */
.highlight .nn { color: #F8F8F2 } /* Name.Namespace */
.highlight .nx { color: #A6E22E } /* Name.Other */
.highlight .py { color: #F8F8F2 } /* Name.Property */
.highlight .nt { color: #FF4689 } /* Name.Tag */
.highlight .nv { color: #F8F8F2 } /* Name.Variable */
.highlight .ow { color: #FF4689 } /* Operator.Word */
.highlight .pm { color: #F8F8F2 } /* Punctuation.Marker */
.highlight .w { color: #F8F8F2 } /* Text.Whitespace */
.highlight .mb { color: #AE81FF } /* Literal.Number.Bin */
.highlight .mf { color: #AE81FF } /* Literal.Number.Float */
.highlight .mh { color: #AE81FF } /* Literal.Number.Hex */
.highlight .mi { color: #AE81FF } /* Literal.Number.Integer */
.highlight .mo { color: #AE81FF } /* Literal.Number.Oct */
.highlight .sa { color: #E6DB74 } /* Literal.String.Affix */
.highlight .sb { color: #E6DB74 } /* Literal.String.Backtick */
.highlight .sc { color: #E6DB74 } /* Literal.String.Char */
.highlight .dl { color: #E6DB74 } /* Literal.String.Delimiter */
.highlight .sd { color: #E6DB74 } /* Literal.String.Doc */
.highlight .s2 { color: #E6DB74 } /* Literal.String.Double */
.highlight .se { color: #AE81FF } /* Literal.String.Escape */
.highlight .sh { color: #E6DB74 } /* Literal.String.Heredoc */
.highlight .si { color: #E6DB74 } /* Literal.String.Interpol */
.highlight .sx { color: #E6DB74 } /* Literal.String.Other */
.highlight .sr { color: #E6DB74 } /* Literal.String.Regex */
.highlight .s1 { color: #E6DB74 } /* Literal.String.Single */
.highlight .ss { color: #E6DB74 } /* Literal.String.Symbol */
.highlight .bp { color: #F8F8F2 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #A6E22E } /* Name.Function.Magic */
.highlight .vc { color: #F8F8F2 } /* Name.Variable.Class */
.highlight .vg { color: #F8F8F2 } /* Name.Variable.Global */
.highlight .vi { color: #F8F8F2 } /* Name.Variable.Instance */
.highlight .vm { color: #F8F8F2 } /* Name.Variable.Magic */
.highlight .il { color: #AE81FF } /* Literal.Number.Integer.Long */
    </style>
</head>
<body>
    <article class="markdown-body">
        <div class="toc"><div class="toc">
<ul>
<li><a href="#learning-xslt-with-python">Learning XSLT with Python</a></li>
<li><a href="#background-a-tale-of-two-philosophies">Background: A Tale of Two Philosophies</a><ul>
<li><a href="#quick-start">Quick Start</a><ul>
<li><a href="#testing-xpath-patterns">Testing XPath Patterns</a></li>
<li><a href="#evaluating-xslt-programs">Evaluating XSLT programs</a></li>
<li><a href="#testing-schemas">Testing Schemas</a></li>
</ul>
</li>
<li><a href="#thinking-in-trees-a-new-paradigm-for-python-developers">Thinking in Trees: A New Paradigm for Python Developers</a><ul>
<li><a href="#build-a-custom-professor">Build a Custom Professor</a></li>
<li><a href="#hack-to-learn-workflow">Hack-to-Learn Workflow</a></li>
<li><a href="#recommended-curriculum">Recommended Curriculum</a></li>
<li><a href="#build-an-amoury">Build an Amoury</a></li>
<li><a href="#understanding-xslts-default-behavior-and-why-its-so-confusing">Understanding XSLT's Default Behavior (And Why It's So Confusing)</a><ul>
<li><a href="#how-to-take-back-control">How to Take Back Control</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#installation-instructions">Installation Instructions</a></li>
<li><a href="#running-examples">Running Examples</a><ul>
<li><a href="#how-to-run-specific-examples">How to Run Specific Examples</a></li>
<li><a href="#running-your-own-examples">Running Your Own Examples</a></li>
<li><a href="#json-transform-example-1">JSON Transform Example 1</a></li>
<li><a href="#json-transform-example-2">JSON Transform Example 2</a></li>
</ul>
</li>
<li><a href="#integrating-xslt-30-with-python-in-the-main-thread">Integrating XSLT 3.0 with Python in the main thread</a></li>
<li><a href="#integrating-xslt-30-with-multithreaded-python">Integrating XSLT 3.0 with Multithreaded Python</a></li>
<li><a href="#xml-schemas">XML Schemas</a><ul>
<li><a href="#unspecified-xml-leads-to-disaster-its-a-timebomb">Unspecified XML Leads to Disaster (It's a timebomb)</a></li>
<li><a href="#a-brilliant-trap-the-saxon-give-them-enough-rope-business-model">A Brilliant Trap: The Saxon "Give Them Enough Rope" Business Model</a></li>
<li><a href="#schema-technologies">Schema Technologies</a><ul>
<li><a href="#dtd-document-type-definition">DTD (Document Type Definition)</a></li>
<li><a href="#xds-10">XDS 1.0</a></li>
<li><a href="#relax-ng">RELAX NG</a></li>
<li><a href="#schematron">Schematron</a></li>
<li><a href="#xds-11">XDS 1.1</a></li>
</ul>
</li>
<li><a href="#xds-11-cli-and-training">XDS 1.1 CLI and Training</a></li>
<li><a href="#schematron-cli-and-training">Schematron CLI and Training</a></li>
<li><a href="#xds-11-python-integration">XDS 1.1 Python Integration</a></li>
<li><a href="#scematron-python-integration">Scematron Python Integration</a></li>
<li><a href="#embracing-the-necessary-pain-of-xml-namespaces">Embracing the Necessary Pain of XML Namespaces</a></li>
</ul>
</li>
<li><a href="#testing-xpath">Testing XPath</a></li>
<li><a href="#testing-xpath-axis-features">Testing XPath Axis Features</a></li>
<li><a href="#prototyping-your-xsltxpath-code-in-python">Prototyping your XSLT/XPATH code in Python</a></li>
<li><a href="#useful-links">Useful links</a></li>
</ul>
</div>
</div>
        <h1 id="learning-xslt-with-python">Learning XSLT with Python</h1>
<p>This repository is a playground for exploring XSLT, a powerful functional
language for data transformation, from within a modern Python environment. It
provides a declarative, "single-step" paradigm for tackling complex data
plumbing challenges in a way that is fundamentally different from traditional
imperative code.</p>
<p>Here you can learn and experiment with XSLT via the command line, using tools and examples for:</p>
<ul>
<li>Building and debugging XSLT stylesheets.</li>
<li>Validating XML using XDS 1.1 and Schematron.</li>
<li>Testing XPath 3.1 expressions.</li>
<li>Connecting with key training resources (e.g., Michael Kay’s books).</li>
</ul>
<p>The project leverages modern Python libraries like <code>lxml</code> (for <code>XSLT 1.0</code>)
and <code>saxonche</code> (for <code>XSLT +3.0</code>), which adds advanced features like
streaming and native JSON handling.</p>
<h1 id="background-a-tale-of-two-philosophies">Background: A Tale of Two Philosophies</h1>
<p>The histories of Python and XSLT offer a compelling study in how technologies
are shaped. Python's development was famously practitioner-led by Guido van
Rossum, fostering a pragmatic culture that valued <a href="https://www.youtube.com/watch?v=GfH4QL4VqJ0">developer happiness</a>. Its
evolution via the community-driven <a href="https://peps.python.org/pep-0001/">PEP process</a> meant it was built by and for
programmers. In stark contrast, XSLT was born from a top-down W3C committee of
architects. The result was a language that was formally powerful but actively
hostile to the sensibilities of the average developer, burdened by a punishingly
verbose XML-based syntax and a steep, declarative-functional learning curve that
felt extraterrestrial to most practitioners.</p>
<p>This difference had profound consequences and directly explains why XSLT fell
into mainstream obscurity. While Python's flexibility allowed it to find a
"killer app" by <a href="https://www.youtube.com/watch?v=AyenRCJ_4Ww">borg'ing</a> the
scientific world of MATLAB, XSLT's rigidity and poor ergonomics actively
repelled the fast-growing world of web development. As web APIs moved towards
the lightweight, brain-dead simple JSON format, XSLT's heavyweight,
document-centric model felt like using a sledgehammer to crack a nut. While its
champion, Michael Kay, was quietly perfecting it over decades, into a masterpiece
of engineering. The mainstream war had already been lost to tools that were
simply easier, faster, and more enjoyable to use.</p>
<p>Today, however, these two histories have converged. With the advent of libraries
like saxonche, XSLT has effectively borg'd itself into the Python ecosystem,
not as a competitor, but as a specialized engine for the kind of complex data
plumbing it was designed for. Freed from having to be a general-purpose tool,
its difficult nature is less of a barrier. It allows developers to use the right
tool for the job: Python for orchestration, and XSLT for the powerful, if
sometimes brutal, rule-based data transformations at which it remains unmatched.</p>
<h2 id="quick-start">Quick Start</h2>
<p>Clone the repo:</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/aleph2c/learning_xslt_with_python.git
<span class="nb">cd</span><span class="w"> </span>learning_xslt_with_python
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
<span class="nb">source</span><span class="w"> </span>venv/bin/activate
xslt<span class="w"> </span>install-compiler-errors<span class="w">  </span><span class="c1"># installs Java version of sachonche</span>
</code></pre></div>

<h3 id="testing-xpath-patterns">Testing XPath Patterns</h3>
<p>XSLT's power comes from XPath, which uses <strong>axes</strong> like <code>child::</code>,
<code>parent::</code>, and <code>ancestor::</code> to navigate the XML tree. The diagram below
illustrates these relationships. You can experiment with them by running your
own XPath expressions against the corresponding /patterns/axis_testing.xml file,
which represents this exact tree structure.</p>
<p><img alt="xpath 2" src="patterns/xpath_2.svg" /></p>
<p>To see the entire XML file, we could set the context to the "root" node then match
against everything in the document:</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>-d<span class="w"> </span>patterns/<span class="w"> </span>xpath<span class="w"> </span>-x<span class="s2">&quot;axis_testing.xml&quot;</span><span class="w"> </span>-c<span class="s2">&quot;/&quot;</span><span class="w"> </span>-p<span class="s2">&quot;*&quot;</span>
context:<span class="w"> </span>/
&lt;A<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>&gt;
<span class="w">  </span>&lt;B<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>&gt;
<span class="w">    </span>&lt;C<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;3&quot;</span>/&gt;
<span class="w">    </span>&lt;D<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;4&quot;</span>/&gt;
<span class="w">    </span>&lt;E<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;5&quot;</span>&gt;
<span class="w">      </span>&lt;H<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;8&quot;</span>&gt;
<span class="w">        </span>&lt;M<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;13&quot;</span>/&gt;
<span class="w">      </span>&lt;/H&gt;
<span class="w">      </span>&lt;I<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;9&quot;</span>/&gt;
<span class="w">      </span>&lt;J<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;10&quot;</span>&gt;
<span class="w">        </span>&lt;N<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;14&quot;</span>/&gt;
<span class="w">        </span>&lt;O<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;15&quot;</span>&gt;
<span class="w">          </span>&lt;T<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;20&quot;</span>/&gt;
<span class="w">          </span>&lt;U<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;21&quot;</span>/&gt;
<span class="w">        </span>&lt;/O&gt;
<span class="w">        </span>&lt;P<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;16&quot;</span>/&gt;
<span class="w">        </span>&lt;Q<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;17&quot;</span>/&gt;
<span class="w">        </span>&lt;R<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;18&quot;</span>&gt;
<span class="w">          </span>&lt;V<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;22&quot;</span>/&gt;
<span class="w">          </span>&lt;W<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;23&quot;</span>/&gt;
<span class="w">        </span>&lt;/R&gt;
<span class="w">      </span>&lt;/J&gt;
<span class="w">      </span>&lt;K<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;11&quot;</span>/&gt;
<span class="w">      </span>&lt;L<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;12&quot;</span>&gt;
<span class="w">        </span>&lt;S<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;19&quot;</span>/&gt;
<span class="w">      </span>&lt;/L&gt;
<span class="w">    </span>&lt;/E&gt;
<span class="w">    </span>&lt;F<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;6&quot;</span>/&gt;
<span class="w">    </span>&lt;G<span class="w"> </span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;7&quot;</span>/&gt;
<span class="w">  </span>&lt;/B&gt;
&lt;/A&gt;
</code></pre></div>

<p>Now let's set <code>J</code> as the node context and perform our first axis experiment:</p>
<div class="codehilite"><pre><span></span><code>try xpath -c &quot;//J&quot; -p &quot;self::*/name()&quot;
context: //J
J
</code></pre></div>

<p>Since the command is lazy, we can query from the <code>J</code> context without
re-specifying it and look back at <code>J's</code> ancestors like this:</p>
<div class="codehilite"><pre><span></span><code>try xpath -p &quot;ancestor::*/name()&quot;
context: //J
J
&quot;A&quot;
&quot;B&quot;
&quot;E&quot;
</code></pre></div>

<blockquote>
<p><strong>Note</strong>
If you are parsing an <code>xhtml</code> doc include the <code>xhtml</code> namespace prefix in your query:
<code>try -d oneal xpath -x example.html -c "/" -p "//xhtml:h1[1]"</code></p>
</blockquote>
<h3 id="evaluating-xslt-programs">Evaluating XSLT programs</h3>
<p>To learn XSLT for transforming XML data, you can use this repository’s
command-line tools and XSLT compilers (installation instructions below). Suppose
you’re working through Chapter 7.4 of Sal Mangano’s XSLT Cookbook and have
transcribed the <code>text-hierarchy.xsl</code> example into
<code>sal/ch07/text-hierarchy.xsl</code>. You want to transform <code>books.xml</code> into
<code>text-hierarchy.txt</code> using this XSLT program.</p>
<p>To do this:</p>
<ul>
<li>Set the working directory as <code>sal/ch07</code>, and</li>
<li>Use the <code>text-hierarchy.xsl</code> XSLT program to transform <code>books.xml</code>.</li>
<li>Pass an <code>indent</code> parameter (four space) to control output formatting</li>
<li>Save the result to <code>text-hierarchy.txt</code> file.</li>
<li>Display verbose output (<code>-v</code>) for debugging.</li>
</ul>
<p>Run the following command:</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>-d<span class="w"> </span>sal/ch07<span class="w"> </span>ex<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-x<span class="w"> </span>books.xml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span>saxon<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-l<span class="w"> </span>text-hierarchy.xsl<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--params<span class="w"> </span><span class="s2">&quot;indent=&#39;    &#39;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-o<span class="w"> </span>text.hieracrhy.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-v
</code></pre></div>

<p>If you’re learning XSLT, you might make mistakes in <code>text-hierarchy.xsl</code>. The
try command caches its inputs, so if you encounter compiler errors, you can edit
the XSLT file and re-run the transformation without retyping
the full command:</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>ex<span class="w"> </span>-v
</code></pre></div>

<p>Repeat this cycle — edit <code>text-hierarchy.xsl</code>, run try ex -v, and check errors
— until your XSLT program produces the desired <code>text-hierarchy.txt</code> output.</p>
<h3 id="testing-schemas">Testing Schemas</h3>
<p>This training repo contains code and examples for testing the XDS 1.1 and
schematron XML schema technologies.  (See <code>schema/xds1.1</code> and
<code>schema/schematron</code> for examples - (only support upto XSLT 2.0))</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>-d<span class="w"> </span>schema/xsd1.1<span class="w"> </span>check<span class="w"> </span>-x<span class="w"> </span>validate_employees_1.xml<span class="w"> </span>exmployees_1.xsd
PASSED
try<span class="w"> </span>-d<span class="w"> </span>schema/schematron<span class="w"> </span>check<span class="w"> </span>-x<span class="w"> </span>valid_staff_1.xml<span class="w"> </span>staff_rules_1.sch
PASSED
</code></pre></div>

<h2 id="thinking-in-trees-a-new-paradigm-for-python-developers">Thinking in Trees: A New Paradigm for Python Developers</h2>
<p><strong>XSLT is a powerful, declarative language for transforming complex data
structures.</strong> While Python templating libraries like Jinja2 are excellent for
generating text from data, XSLT is a specialized tool designed for the
structural transformation of tree-like data such as XML and JSON.</p>
<p>The fundamental difference lies in its thinking model. Instead of writing
imperative Python code that loops through data, you write declarative XSLT
rules. You define what the output should look like for a given pattern, and the
XSLT processor, powered by the XPath query language, figures out how to apply
those rules across the entire document. This functional, rule-based approach can
be incredibly efficient for handling large or complex data streams.</p>
<p>Python supports XSLT through libraries like <code>lxml</code>, but this is limited to the
older, more basic XSLT 1.0 standard. This repository focuses on the modern XSLT
3.0 via the saxonche library, which provides full support for advanced features,
including native JSON handling.</p>
<p>Because this declarative, rule-based paradigm is so different from imperative
Python, learning it requires a new approach. This repository provides a complete
workflow to become fluent:</p>
<ol>
<li>Build a custom AI "Professor" to act as your personal tutor.</li>
<li>Follow a "hack-to-learn" workflow using the provided code examples.</li>
<li>Use a curated curriculum based on some classic XSLT texts.</li>
<li>Build an Amoury</li>
</ol>
<h3 id="build-a-custom-professor">Build a Custom Professor</h3>
<p>Copy the following markdown into a context file and feed it to the AI which is
training you. If you can't do that, just drop it into the AI's prompt.  This
will provide a short hand to turn it into an excellent tutor.</p>
<div class="codehilite"><pre><span></span><code><span class="gh"># AI Interaction Modes for XSLT/XML Development</span>

This document outlines custom interaction modes for consulting on XSLT, XML, and XPath. These modes allow for switching response styles dynamically by using a prefix at the start of a message (e.g., <span class="sb">`TT:1 What is an atomic value?`</span>).

To exit any mode and return to the default, adaptive response style, use the prefix <span class="sb">`NN:`</span> or explicitly ask to leave the current mode.

<span class="gu">## Available Modes</span>

<span class="gu">### TT: Teacher Mode (Using Revised Bloom&#39;s Taxonomy)</span>

<span class="k">*</span><span class="w"> </span>  <span class="gs">**Purpose**</span>: An educational style to help learn XSLT, XML, or XPath by building cognitive skills step-by-step. The mode focuses on one level of the taxonomy per query, providing prompts to evaluate and advance your understanding.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Activation**</span>: Prefix with <span class="sb">`TT:X`</span>, where <span class="sb">`X`</span> is the level from 1 to 6. If no level is specified (<span class="sb">`TT:`</span>), the mode will default to level 1 or infer from the context.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Levels (Revised Bloom&#39;s Taxonomy)**</span>:
<span class="w">    </span><span class="k">1.</span>  <span class="gs">**Remembering (TT:1)**</span>: Recall facts and basic concepts. I&#39;ll ask questions like, &quot;What is the difference between <span class="sb">`xsl:copy`</span> and <span class="sb">`xsl:copy-of`</span>?&quot; or &quot;What are the seven types of XML nodes?&quot;
<span class="w">    </span><span class="k">2.</span>  <span class="gs">**Understanding (TT:2)**</span>: Explain ideas or concepts. I&#39;ll ask for explanations like, &quot;Can you describe what a sequence is in your own words?&quot; or &quot;Explain the purpose of the identity transform.&quot;
<span class="w">    </span><span class="k">3.</span>  <span class="gs">**Applying (TT:3)**</span>: Use information in concrete situations. I&#39;ll provide scenarios like, &quot;Show how you would use <span class="sb">`xsl:for-each-group`</span> to group these items by category.&quot;
<span class="w">    </span><span class="k">4.</span>  <span class="gs">**Analyzing (TT:4)**</span>: Draw connections among ideas. I&#39;ll prompt analysis like, &quot;Compare the built-in default templates to an explicit identity transform. What are the tradeoffs?&quot;
<span class="w">    </span><span class="k">5.</span>  <span class="gs">**Evaluating (TT:5)**</span>: Justify a stand or decision. I&#39;ll ask for critiques like, &quot;Evaluate this template. Is there a more efficient or readable way to write it?&quot;
<span class="w">    </span><span class="k">6.</span>  <span class="gs">**Creating (TT:6)**</span>: Produce new or original work. I&#39;ll guide creation with prompts like, &quot;Design a recursive function that traces the processing of a document.&quot;
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Exit**</span>: Use <span class="sb">`NN:`</span> or say &quot;Exit teacher mode.&quot;

<span class="gu">### AA: XSLT Architect Mode</span>

<span class="k">*</span><span class="w"> </span>  <span class="gs">**Purpose**</span>: High-level architectural and design discussions, focusing on best practices, patterns, and trade-offs without necessarily writing full code solutions. This mode is for exploring the &quot;how&quot; and &quot;why&quot; of a solution&#39;s structure.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Activation**</span>: Prefix with <span class="sb">`AA:`</span>. You can add a sub-focus like:
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  <span class="sb">`AA:patterns`</span>: Discuss common XSLT design patterns (e.g., identity transform, fill-in-the-blanks).
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  <span class="sb">`AA:tradeoffs`</span>: Analyze the pros and cons of different implementation choices (e.g., <span class="sb">`xsl:for-each`</span> vs. <span class="sb">`xsl:apply-templates`</span>).
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  <span class="sb">`AA:ideas`</span>: Brainstorm multiple approaches to solving a complex transformation problem.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Style**</span>:
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Starts by restating the core problem to ensure understanding.
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Generates multiple potential solutions with clear pros and cons (e.g., performance, readability, maintainability).
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Includes risks or &quot;gotchas&quot; for each approach.
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Critiques user-provided ideas rigorously, pointing out potential flaws or edge cases and suggesting robust alternatives.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Exit**</span>: Use <span class="sb">`NN:`</span> or say &quot;Exit architect mode.&quot;

<span class="gu">### LH: Language Historian Mode</span>

<span class="k">*</span><span class="w"> </span>  <span class="gs">**Purpose**</span>: An interdisciplinary discussion exploring the history, design philosophy, and evolution of XSLT/XML and related technologies. This mode focuses on the &quot;why&quot; behind the language&#39;s features and its place in the broader history of technology.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Activation**</span>: Prefix with <span class="sb">`LH:`</span>.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Style**</span>:
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Draws parallels and contrasts between XSLT&#39;s development and that of other languages (like Python).
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Explains the reasoning behind confusing or non-intuitive language features (e.g., XSLT&#39;s default templates).
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Discusses the influence of standards committees (W3C) versus individual or community-led language design.
<span class="w">    </span><span class="k">*</span><span class="w"> </span>  Analyzes the industrial and human factors that lead to a technology&#39;s adoption or decline.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Exit**</span>: Use <span class="sb">`NN:`</span> or say &quot;Exit historian mode.&quot;

<span class="gu">### NN: Normal Mode</span>

<span class="k">*</span><span class="w"> </span>  <span class="gs">**Purpose**</span>: Reset to the standard, adaptive response style for direct questions and answers.
<span class="k">*</span><span class="w"> </span>  <span class="gs">**Activation**</span>: Prefix with <span class="sb">`NN:`</span> or occurs automatically after exiting another mode.
</code></pre></div>

<h3 id="hack-to-learn-workflow">Hack-to-Learn Workflow</h3>
<p>While new XSLT books are rare, the classic texts contain timeless problems and
patterns. This repository provides the code for those exercises, allowing you to
master XSLT using a modern, AI-driven workflow.</p>
<p>The core learning loop is simple: use this repository's code as a foundation and
an AI assistant as your personal tutor. An effective workflow is:</p>
<ol>
<li><strong>Find an Example</strong>: Navigate to a chapter's code within this repository.</li>
<li><strong>Load the Context</strong>: Copy and paste the source XML and the XSLT (<code>.xsl</code>) file into
   your AI session.</li>
<li><strong>Interrogate the Code</strong>: Ask the AI to explain the stylesheet until you
   understand it. Use the AA: (Architect) and LH: (Language Historian) prompts
   to explore why the code is structured a certain way and the design philosophy
   behind it.</li>
<li><strong>Run the Example</strong>: Execute the code using the try command-line helper provided
   by this repository to see it in action.</li>
<li><strong>Test Your Knowledge</strong>: Ask the AI to quiz you. Use the TT: (Teacher) prompts to
   generate targeted questions at different cognitive levels.  (A fast and
   <strong>painful</strong> way to learn is to set the TT prompt well beyond your level of
   competence.  If it hurts you are doing it right.)</li>
</ol>
<h3 id="recommended-curriculum">Recommended Curriculum</h3>
<p>Apply the learning workflow above to this curated training path. The directory names in parentheses correspond to the code in this repository.</p>
<ul>
<li>
<p><strong>1. The Basics (<code>otegem</code>)</strong></p>
<ul>
<li><strong>Book:</strong> <em>Teach Yourself XSLT in 21 Days</em> by Michiel van Otegem.</li>
<li><strong>Focus:</strong> Work through chapters 3-17 to build a strong foundation. Use the <code>try xpath</code> command to master XPath concepts, and build a personal snippet library as you go.</li>
</ul>
</li>
<li>
<p><strong>2. Practical Labs (<code>sal</code>)</strong></p>
<ul>
<li><strong>Book:</strong> <em>XSLT Cookbook</em> by Sal Mangano.</li>
<li><strong>Focus:</strong> These are practical, recipe-style examples. Use the AI to explain the core concept of each recipe before examining the solution. (Key chapters: 15, 6).</li>
</ul>
</li>
<li>
<p><strong>3. Intermediate Concepts (<code>jenni</code>)</strong></p>
<ul>
<li><strong>Book:</strong> <em>Beginning XSLT 2.0</em> by Jeni Tennison.</li>
<li><strong>Focus:</strong> Use the AI to explain the high-level concepts from the chapter headings, then dive into the code examples provided in this repo to see them implemented. (Key chapters: 11, appendix A)</li>
</ul>
</li>
<li>
<p><strong>4. Schemas (<code>schema</code>)</strong></p>
<ul>
<li><strong>Book:</strong> <a href="#xml-schemas">XML Schemas in these docs</a>, use the existing examples and an AI to generate new examples</li>
<li><strong>Focus:</strong> Ensure your xml can be properly guarded and specified with an
    XDS1.1 and schematron schemas.</li>
</ul>
</li>
<li>
<p><strong>5. Advanced Design Patterns (<code>michael</code>, <code>patterns</code>)</strong></p>
<ul>
<li><strong>Book:</strong> Michael Kay’s <em>XSLT 2.0 and XPath 2.0 Programmer's Reference</em>.</li>
<li><strong>Focus:</strong> Specifically Chapter 17: "Stylesheet Design Patterns." This
    is essential reading for writing professional, maintainable XSLT.
    (fill-in-the-blanks stylesheets, navigational stylesheets, rule-based
    stylesheets, computational stylesheets)</li>
</ul>
</li>
<li>
<p><strong>6. Bridging to XSLT 3.0</strong></p>
<ul>
<li>Since there is no single XSLT 3.0 book, use a combination of these excellent resources:<ul>
<li><strong>Michael Kay's Book:</strong> The book above covers much of the foundation needed for 3.0.</li>
<li><strong>Online Examples:</strong> <a href="https://xslt-3-by-example.blogspot.com/">Martin Honnen’s XSLT 3.0 by Example blog</a> and his expert answers on <a href="https://stackoverflow.com/users/252228/martin-honnen">Stack Overflow</a>.</li>
<li><strong>JSON Handling:</strong> Michael Kay's paper, <a href="https://www.saxonica.com/papers/xmlprague-2016mhk.pdf"><em>Transforming JSON using XSLT 3.0</em></a>. (Supporting code is in the <code>/patterns</code> folder of this repo.)</li>
<li><strong>XPath 3.1 Training:</strong> <a href="https://www.altova.com/training/xpath3">Altova’s free training resources</a>.</li>
</ul>
</li>
</ul>
</li>
<li><strong>7. Overview of 3.0 (<code>scott</code>)</strong><ul>
<li>Since there is no single XSLT 3.0 book, use the training patterns in the <code>(scott)</code>
    directory (provided by Grok4)</li>
</ul>
</li>
</ul>
<h3 id="build-an-amoury">Build an Amoury</h3>
<p>To make XSLT less verbose, use editor-snippets.</p>
<p>In Vim/Neovim, SirVer’s UltiSnips is excellent — create your own library as you
learn. Build snippets while reading books, adding comments for reference. Use
UltiSnips’ shortcut to jump between your XSLT file and <a href="https://github.com/aleph2c/.vim/blob/master/snippets/xslt.snippets">snippet
files</a>. Keep
snippets under Git-control for portability.</p>
<h3 id="understanding-xslts-default-behavior-and-why-its-so-confusing">Understanding XSLT's Default Behavior (And Why It's So Confusing)</h3>
<p>The most confusing part of XSLT for newcomers is its set of invisible, built-in
template rules. The best way to understand them is to compare XSLT to CSS.</p>
<p>When you apply a CSS stylesheet to an HTML document, the browser's default
behavior is to render the entire HTML structure. You write CSS rules to <em>style</em>
the elements, but you don't expect the tags themselves (<code>&lt;h1&gt;</code>, <code>&lt;p&gt;</code>, etc.) to
disappear. This is because <strong>HTML is a presentational markup language</strong>; its
tags have an inherent visual meaning to the browser.</p>
<p>XSLT behaves differently. If you apply a completely empty stylesheet to an XML
document, the result is that <strong>all the tags are stripped away, leaving only the
raw text content.</strong> This is baffling at first, but it reveals the core
philosophy of the language. Unlike HTML, <strong>XML is a semantic data language.</strong>
Its tags, like <code>&lt;customer-id&gt;</code> or <code>&lt;price&gt;</code>, have no intrinsic visual meaning.
They are labels for data.</p>
<p>The XSLT designers assumed that the most basic, default operation anyone would
want is to extract the data itself—the text. Therefore, they created two
built-in rules that work together:</p>
<ol>
<li><strong>A Rule for Elements:</strong> This default rule matches any element (<code>*</code>) or the
    root node (<code>/</code>). Its only job is to recursively keep processing
    (<code>&lt;xsl:apply-templates/&gt;</code>). It produces no output for the element tag
    itself; it just keeps digging deeper.</li>
<li><strong>A Rule for Text:</strong> This default rule matches any text node (<code>text()</code>). Its
    job is to copy the value of the text to the output (<code>&lt;xsl:value-of
    select="."/&gt;</code>).</li>
</ol>
<p>When you combine these, the first rule navigates silently through the tree of
element tags, and the second rule shouts out the value of any text it finds
along the way. The result is a stream of text with all its structural context
removed.</p>
<h4 id="how-to-take-back-control">How to Take Back Control</h4>
<p>This default behavior is rarely what you want. Experienced XSLT developers
almost always start by creating a "blank slate." They override the built-in
rules by putting this template at the top of their stylesheet:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- This empty template matches ALL nodes and attributes and does nothing.</span>
<span class="cm">     It effectively disables all the built-in rules. --&gt;</span>
<span class="nt">&lt;xsl:template</span><span class="w"> </span><span class="na">match=</span><span class="s">&quot;node() | @*&quot;</span><span class="nt">/&gt;</span>
</code></pre></div>

<h1 id="installation-instructions">Installation Instructions</h1>
<p>These installation commands will do the following:</p>
<ul>
<li>Install this repo's CLI</li>
<li>Install the two XSLT python parsers (<code>lxml/sachonche</code>)</li>
<li>Get the example programs organized within the book directories</li>
<li>Get a separate version of the Saxonic XSLT that will provide compile errors</li>
</ul>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:aleph2c/leaning_xslt.git
<span class="nb">cd</span><span class="w"> </span>learning_xslt
python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
<span class="nb">source</span><span class="w"> </span>./venv/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
<span class="c1"># see note:</span>
xslt<span class="w"> </span>install-compile-errors
</code></pre></div>

<p><strong>Note:</strong>
The <code>saxonche</code> pip package used by this repo will not output XSLT compiler errors,
but if you want to see them (which you do) this command will fix the problem:</p>
<div class="codehilite"><pre><span></span><code>xslt<span class="w"> </span>install-compiler-errors
</code></pre></div>

<p>This will download the
<a href="https://github.com/Saxonica/Saxon-HE/blob/be4dd844d935d8d0ef09748490448624abe3c66b/12/source/saxon12-0source.zip">zipped java version of saxon</a>
and decompress its contents in <code>./java/</code>.  With this jar installed the <code>try</code>
cli tool will call out to java when the <code>saxoniche</code> library fails to compile
your <code>.xsl</code>.  It will rerun the compilation using the jar and output the XSLT
compiler error messages to the terminal.  This will give you the feedback
required to debug your programs.</p>
<h1 id="running-examples">Running Examples</h1>
<p>The repo installs a <code>try</code> command.  To see how it works:</p>
<div class="codehilite"><pre><span></span><code>try --help
Usage: try [OPTIONS] COMMAND [ARGS]...

    Try an XSLT/XPath example and cache the command

Options:
  -d, --dir TEXT  Set the exercise directory
  --help          Show this message and exit.

  Commands:
    cache  View your command cache
    ex     Run an exercise
    xpath  Test an XPath query on a given xml doc and context
</code></pre></div>

<h2 id="how-to-run-specific-examples">How to Run Specific Examples</h2>
<p>To see how to run an exercise:</p>
<div class="codehilite"><pre><span></span><code>try ex --help
Usage: try ex [OPTIONS]

  Run an exercise:

  try -d sal/ch07 ex \
    -x books.xml \
    -l text.hierarchy.xsl \
    -params &quot;indent=&#39;    &#39;,param2=&#39;some_value&#39;&quot; \
    -o text.hierarchy.txt

Options:
  -n, --node-name TEXT    Set the node name
  -x, --xml TEXT          Set the xml file
  -j, --json TEXT         Set the json file (saxon)
  -l, --xls TEXT          Set the xls file
  -p, --processor TEXT    Set the processor (lxml|saxon)
  -o, --output_file TEXT  Set the output file name
  --params TEXT           Set the optional parameter(s)
  -v, --verbose           Run in verbose mode?
  --help                  Show this message and exit.
</code></pre></div>

<p>To run an example:</p>
<div class="codehilite"><pre><span></span><code><span class="n">try -d jenni/ch2_html_from_xml ex -x TVGuide2.xml -l TVGuide2.xsl -o TVGuide2.html -p lxml -v</span>
<span class="c"># a lot of XML</span>

<span class="n">ran the lxml process</span>
</code></pre></div>

<p>To see your cache:</p>
<div class="codehilite"><pre><span></span><code><span class="n">try cache</span>
<span class="n">{&#39;context&#39;: &#39;&#39;, &#39;home_dir&#39;: &#39;jenni/home/scott/xslt/ch3_templates&#39;,</span>
<span class="n">&#39;output_file_name&#39;: &#39;TVGuide2.html&#39;, &#39;processor&#39;: &#39;lxml&#39;, </span>
<span class="n">&#39;xls_file_name&#39;: &#39;TVGuide2.xsl&#39;, &#39;xml_file_name&#39;: &#39;TVGuide2.xml&#39;}</span>
</code></pre></div>

<p>To run the same exercise again:</p>
<div class="codehilite"><pre><span></span><code>try ex -v
# a lot of XML

ran the lxml processor
</code></pre></div>

<p>To try the same example with the saxon processor, you just have to tell the
<code>try</code> command you want to use the <code>saxon</code> processor, if the other options
are not specified it will use your cached options:</p>
<div class="codehilite"><pre><span></span><code>try ex -p saxon -v
# a lot of XML

ran the saxon processor
</code></pre></div>

<h2 id="running-your-own-examples">Running Your Own Examples</h2>
<p>To run examples from a different book, add descriptives folder names and put
your xml and xsl files in these folders.  Use the <code>-d</code> flag to point to the
folder you are working with, then run the sub-commands as you did before.</p>
<h2 id="json-transform-example-1">JSON Transform Example 1</h2>
<p>In this example we will perform a transform to increase the price of a product
tagged with "ice" by 10 percent (see ./patterns/to_json.xs):</p>
<p>Given this input:</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="k">tool</span><span class="w"> </span><span class="o">./</span><span class="n">michael</span><span class="o">/</span><span class="n">json_input</span><span class="o">.</span><span class="n">json</span>

<span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;An ice sculpture&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">12.50</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;cold&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ice&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="s2">&quot;dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">7.0</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">12.0</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">9.5</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s2">&quot;warehouseLocation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mf">78.75</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">20.4</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A blue mouse&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">25.50</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3.1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s2">&quot;warehouseLocation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">54.4</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mf">32.7</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p>Perform a transform (saxonpy works, saxonche stackoverflow):</p>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> this will crash with saxonche 12.0 due to stackoverflow errors
<span class="gh">#</span> but will run with saxonche 12.1

try -d michael \
  ex -j json_input.json \
     -l to_json.xsl \
     -o json_output.json \
     -p saxon
</code></pre></div>

<p>This will create the following output:</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="k">tool</span><span class="w"> </span><span class="o">./</span><span class="n">michael</span><span class="o">/</span><span class="n">json_output</span><span class="o">.</span><span class="n">json</span>

<span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;An ice sculpture&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">13.75</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;cold&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;ice&quot;</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="s2">&quot;dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">9.5</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="s2">&quot;warehouseLocation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mf">78.75</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">20.4</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A blue mouse&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">25.5</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;length&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3.1</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;height&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="s2">&quot;warehouseLocation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">54.4</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mf">32.7</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<h2 id="json-transform-example-2">JSON Transform Example 2</h2>
<p>We would like to invert the hierarchy of a json document. In this example we
will take the data being organized from faculty-&gt;courses-&gt;students-&gt;email and
transform it to email-&gt;courses.  We will also sort the output based on last name
and then the first name of each student, but we will keep the student's name out
of the final output.</p>
<p>Given this input:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>
<span class="n">  {</span>
<span class="n">    &quot;faculty&quot;: &quot;humanities&quot;,</span>
<span class="n">    &quot;courses&quot;: [</span>
<span class="n">      {</span>
<span class="n">        &quot;course&quot;: &quot;English&quot;,</span>
<span class="n">        &quot;students&quot;: [</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;Mary&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Smith&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;mary_smith@gmail.com&quot;</span>
<span class="n">          },</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;Ann&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Jones&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;ann_jones@gmail.com&quot;</span>
<span class="n">          }</span>
<span class="n">        </span><span class="o">]</span>
<span class="w">      </span><span class="err">}</span><span class="p">,</span>
<span class="w">      </span><span class="err">{</span>
<span class="w">        </span><span class="ss">&quot;course&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;History&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;students&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;Ann&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Jones&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;ann_jones@gmail.com&quot;</span>
<span class="n">          },</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;John&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Taylor&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;john_taylor@gmail.com&quot;</span>
<span class="n">          }</span>
<span class="n">        </span><span class="o">]</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">    </span><span class="err">]</span>
<span class="w">  </span><span class="err">}</span><span class="p">,</span>
<span class="w">  </span><span class="err">{</span>
<span class="w">    </span><span class="ss">&quot;faculty&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;science&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;courses&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span>
<span class="n">      {</span>
<span class="n">        &quot;course&quot;: &quot;Physics&quot;,</span>
<span class="n">        &quot;students&quot;: [</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;Anil&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Singh&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;anil_singh@gmail.com&quot;</span>
<span class="n">          },</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;Amisha&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Patel&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;amisha_patel@gmail.com&quot;</span>
<span class="n">          }</span>
<span class="n">        </span><span class="o">]</span>
<span class="w">      </span><span class="err">}</span><span class="p">,</span>
<span class="w">      </span><span class="err">{</span>
<span class="w">        </span><span class="ss">&quot;course&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;Chemistry&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;students&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;John&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Taylor&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;john_taylor@gmail.com&quot;</span>
<span class="n">          },</span>
<span class="n">          {</span>
<span class="n">            &quot;first&quot;: &quot;Anil&quot;,</span>
<span class="n">            &quot;last&quot;: &quot;Singh&quot;,</span>
<span class="n">            &quot;email&quot;: &quot;anil_singh@gmail.com&quot;</span>
<span class="n">          }</span>
<span class="n">        </span><span class="o">]</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">    </span><span class="err">]</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">]</span>
</code></pre></div>

<p>Perform the transform (saxonpy works, saxonche stackoverflow):</p>
<div class="codehilite"><pre><span></span><code>try -d michael \
  ex -x json_input2.json \
     -l to_json2.xsl \
     -o json_output2.json \
     -p saxon
</code></pre></div>

<p>This will produce the following output</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="k">tool</span><span class="w"> </span><span class="o">./</span><span class="n">patterns</span><span class="o">/</span><span class="n">json_output2</span><span class="o">.</span><span class="n">json</span>

<span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ann_jones@gmail.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;courses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;English&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;History&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;amisha_patel@gmail.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;courses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;Physics&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;anil_singh@gmail.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;courses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;Physics&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Chemistry&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mary_smith@gmail.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;courses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;English&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;john_taylor@gmail.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;courses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;History&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Chemistry&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<h1 id="integrating-xslt-30-with-python-in-the-main-thread">Integrating XSLT 3.0 with Python in the main thread</h1>
<p>The <a href="https://pypi.org/project/saxonche/">saxonche documentation</a> is incomplete
and almost useless.  To see fixed versions of the low quality python examples
provided by Saxonica look in the <code>oneal</code> folder of this repo.</p>
<p>If you want to get your python code to parse XML/JSON/XSLT and output XML/JSON
using <code>saxonche</code> consider the following:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">saxonche</span><span class="w"> </span><span class="kn">import</span> <span class="n">PySaxonProcessor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">transform_with_saxonche</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">home_dir</span><span class="p">,</span> <span class="n">xml_file_name</span><span class="p">,</span> <span class="n">xsl_file_name</span><span class="p">,</span> <span class="n">output_file_name</span>
<span class="p">):</span>
    <span class="c1"># Don&#39;t use the PySaxonProcess context manager if you are calling saxonche</span>
    <span class="c1"># over and over again within your program.  Instead build the proc and</span>
    <span class="c1"># xsltproc once, and reference them when you need them.  If you don&#39;t do</span>
    <span class="c1"># this, you will get strange memory errors:</span>
    <span class="c1"># &quot;JNI_CreateJavaVM() failed with result: -5&quot; (last seen in saxonc-he 11.4)</span>
    <span class="c1">#</span>
    <span class="c1"># Example of how to build the proc and xsltproc once per program invocation:</span>
    <span class="c1">#</span>
    <span class="c1"># from functools import cache as cached</span>
    <span class="c1"># @cached</span>
    <span class="c1"># def get_cached_procs_from(*args):</span>
    <span class="c1">#   proc = PySaxonProcessor(licence=False)</span>
    <span class="c1">#   xsltproc = proc.new_xslt30_processor()</span>
    <span class="c1">#   return proc, xsltproc</span>
    <span class="c1">#</span>
    <span class="c1"># def transform_with_saxonche(...)</span>
    <span class="c1">#   proc, xsltproc = get_cached_procs_from(PySaxonProcessor)</span>
    <span class="c1">#   # ...</span>

    <span class="c1"># If you are running your transforms once per program invocation</span>
    <span class="c1"># you can use the PySaxonProcessor context manager.  Don&#39;t be fooled, given</span>
    <span class="c1"># that this context manager doesn&#39;t clean up memory when it&#39;s done, it&#39;s not</span>
    <span class="c1"># really behaving like a Python context manager. (see the memory bug</span>
    <span class="c1"># mentioned above)</span>
    <span class="k">with</span> <span class="n">PySaxonProcessor</span><span class="p">(</span><span class="n">license</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
        <span class="n">xsltproc</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">new_xslt30_processor</span><span class="p">()</span>
        <span class="n">xsltproc</span><span class="o">.</span><span class="n">set_cwd</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">home_dir</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home_dir</span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">xml_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;xml_file_name: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xml_file_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span>
            <span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">xsl_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;xsl_file_name: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xsl_file_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span>
            <span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">xml_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="n">json_input_param</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">make_string_value</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">home_dir</span> <span class="o">/</span> <span class="n">xml_file_name</span><span class="p">))</span>
            <span class="n">xsltproc</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="s2">&quot;json_input_filename&quot;</span><span class="p">,</span> <span class="n">json_input_param</span><span class="p">)</span>

        <span class="n">stylesheet_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">xsl_file_name</span><span class="p">)</span>
        <span class="n">_exec</span> <span class="o">=</span> <span class="n">xsltproc</span><span class="o">.</span><span class="n">compile_stylesheet</span><span class="p">(</span>
            <span class="n">stylesheet_file</span><span class="o">=</span><span class="n">stylesheet_file</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">_exec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saxonica failed&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">xml_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="c1"># it&#39;s a mystery why we have to use call_template_returning_file</span>
            <span class="c1"># and not make_string_value (this isn&#39;t documented anywhere)</span>
            <span class="n">_exec</span><span class="o">.</span><span class="n">call_template_returning_file</span><span class="p">(</span><span class="n">output_file</span><span class="o">=</span><span class="n">output_file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add a test_param to validate saxon is working</span>
            <span class="n">test_param</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">make_string_value</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">home_dir</span> <span class="o">/</span> <span class="n">xml_file_name</span><span class="p">))</span>
            <span class="n">_exec</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="s2">&quot;test_param&quot;</span><span class="p">,</span> <span class="n">test_param</span><span class="p">)</span>
            <span class="n">_exec</span><span class="o">.</span><span class="n">set_initial_match_selection</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">xml_file_name</span><span class="p">)</span>
            <span class="n">_exec</span><span class="o">.</span><span class="n">apply_templates_returning_file</span><span class="p">(</span><span class="n">output_file</span><span class="o">=</span><span class="n">output_file_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">home_dir</span> <span class="o">/</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</code></pre></div>

<h1 id="integrating-xslt-30-with-multithreaded-python">Integrating XSLT 3.0 with Multithreaded Python</h1>
<div class="codehilite"><pre><span></span><code><span class="c1"># This doesn&#39;t cause StackOverFlow crashes and, its fully documented </span>
<span class="c1"># and its documentation isn&#39;t wrong.  It only support XSLT 1.0</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lxml</span>
</code></pre></div>

<p>But if you are willing to accept some risk, here is a working demo of Python thread
performing XSLT transforms using saxonche without causing StackOverFlows:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># working copy can be found in ./cli/thread_demo.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid1</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span> <span class="k">as</span> <span class="n">ThreadEvent</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">saxonche</span><span class="w"> </span><span class="kn">import</span> <span class="n">PySaxonProcessor</span>

<span class="n">proc_globals</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">proc_globals_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
<span class="n">ValidateXmlPath</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;validate_xml.xsl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
<span class="n">SaxonPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;SaxonPayload&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;home_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;xml_file_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xsl_file_name&quot;</span><span class="p">,</span> <span class="s2">&quot;output_file_name&quot;</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">__initialize_saxon</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The PySaxonProcessor proc and the xslt30 proc should only be made once&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;proc&quot;</span> <span class="ow">in</span> <span class="n">proc_globals</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">proc_globals</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">]</span>
        <span class="n">xsltproc</span> <span class="o">=</span> <span class="n">proc_globals</span><span class="p">[</span><span class="s2">&quot;xsltproc&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">PySaxonProcessor</span><span class="p">(</span><span class="n">license</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">xsltproc</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">new_xslt30_processor</span><span class="p">()</span>
        <span class="n">proc_globals</span><span class="p">[</span><span class="s2">&quot;proc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc</span>
        <span class="n">proc_globals</span><span class="p">[</span><span class="s2">&quot;xsltproc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xsltproc</span>

    <span class="k">return</span> <span class="n">proc</span><span class="p">,</span> <span class="n">xsltproc</span>

<span class="c1"># call this from the main thread at least once</span>
<span class="n">proc_globals_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="n">__initialize_saxon</span><span class="p">()</span>
<span class="n">proc_globals_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">__saxon_xslt30_transform</span><span class="p">(</span>
    <span class="n">lock</span><span class="p">,</span> <span class="n">home_dir</span><span class="p">,</span> <span class="n">xml_file_name</span><span class="p">,</span> <span class="n">xsl_file_name</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">proc</span><span class="p">,</span> <span class="n">xsltproc</span> <span class="o">=</span> <span class="n">__initialize_saxon</span><span class="p">()</span>

    <span class="n">home_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span>
    <span class="n">xml_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">xml_file_name</span>
    <span class="n">xsl_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">xsl_file_name</span>
    <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">output_file_name</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">home_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">home_dir</span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;xml_file_name: </span><span class="si">{</span><span class="n">xml_file_path</span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">xsl_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;xsl_file_name: </span><span class="si">{</span><span class="n">xsl_file_path</span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">stashed_output_file_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">xml_file_path</span> <span class="o">==</span> <span class="n">output_file_path</span><span class="p">:</span>
        <span class="n">temp_output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid1</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">)</span>
        <span class="n">stashed_output_file_path</span> <span class="o">=</span> <span class="n">output_file_path</span>
        <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">temp_output_path</span>

    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">xml_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
        <span class="n">json_input_param</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">make_string_value</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">home_dir</span> <span class="o">/</span> <span class="n">xml_file_name</span><span class="p">))</span>
        <span class="n">xsltproc</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="s2">&quot;json_input_filename&quot;</span><span class="p">,</span> <span class="n">json_input_param</span><span class="p">)</span>

    <span class="n">_exec</span> <span class="o">=</span> <span class="n">xsltproc</span><span class="o">.</span><span class="n">compile_stylesheet</span><span class="p">(</span><span class="n">stylesheet_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">xsl_file_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">_exec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xsltproc</span><span class="o">.</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">xsltproc</span><span class="o">.</span><span class="n">exception_clear</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">xml_file_name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
        <span class="c1"># it&#39;s a mystery why we have to use call_template_returning_file</span>
        <span class="c1"># and not make_string_value (this isn&#39;t documented anywhere)</span>
        <span class="n">_exec</span><span class="o">.</span><span class="n">call_template_returning_file</span><span class="p">(</span><span class="n">output_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stashed_output_file_path</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">stashed_output_file_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">)</span>
            <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">stashed_output_file_path</span>
        <span class="k">del</span> <span class="n">_exec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># add a test_param to validate saxon is working</span>
        <span class="n">test_param</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">make_string_value</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xml_file_path</span><span class="p">))</span>
        <span class="n">_exec</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="s2">&quot;test_param&quot;</span><span class="p">,</span> <span class="n">test_param</span><span class="p">)</span>
        <span class="n">_exec</span><span class="o">.</span><span class="n">set_initial_match_selection</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">xml_file_path</span><span class="p">))</span>
        <span class="n">_exec</span><span class="o">.</span><span class="n">apply_templates_returning_file</span><span class="p">(</span><span class="n">output_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_exec</span><span class="o">.</span><span class="n">exception_occurred</span><span class="p">:</span>
            <span class="n">saxon_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_exec</span><span class="o">.</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">_exec</span><span class="o">.</span><span class="n">exception_clear</span><span class="p">()</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">saxon_error</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stashed_output_file_path</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">stashed_output_file_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">)</span>
            <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">stashed_output_file_path</span>

        <span class="c1"># if our output path is an .xml file, run a post-transform-test to see</span>
        <span class="c1"># if the provided xsl_file_name created valid xml</span>
        <span class="k">if</span> <span class="n">output_file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.xml&#39;</span><span class="p">:</span>
            <span class="n">xsl_post_test_path</span> <span class="o">=</span> <span class="n">ValidateXmlPath</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">xsl_post_test_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;xsl_file_name:</span><span class="se">\n</span><span class="si">{</span><span class="n">xsl_post_test_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">doesn&#39;t exist&quot;</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="n">_exec</span> <span class="o">=</span> <span class="n">xsltproc</span><span class="o">.</span><span class="n">compile_stylesheet</span><span class="p">(</span><span class="n">stylesheet_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">xsl_post_test_path</span><span class="p">))</span>

            <span class="n">_exec</span><span class="o">.</span><span class="n">transform_to_string</span><span class="p">(</span>
                <span class="n">source_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">_exec</span><span class="o">.</span><span class="n">exception_occurred</span><span class="p">:</span>
                <span class="n">saxon_error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_exec</span><span class="o">.</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_exec</span><span class="o">.</span><span class="n">exception_clear</span><span class="p">()</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">saxon_error</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">_exec</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">home_dir</span> <span class="o">/</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">thread_runner</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">task_event</span><span class="p">,</span> <span class="n">input_queue</span><span class="p">,</span> <span class="n">output_queue</span><span class="p">):</span>

    <span class="c1"># this will cause the StackOverFlow if it isn&#39;t first called</span>
    <span class="c1"># in the main thread</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">__initialize_saxon</span><span class="p">()</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">task_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">input_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">input_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">__saxon_xslt30_transform</span><span class="p">(</span>
            <span class="n">lock</span><span class="p">,</span>
            <span class="n">home_dir</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">home_dir</span><span class="p">,</span>
            <span class="n">xml_file_name</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">xml_file_name</span><span class="p">,</span>
            <span class="n">xsl_file_name</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">xsl_file_name</span><span class="p">,</span>
            <span class="n">output_file_name</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">output_file_name</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">output_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># this function demontrates how to create a thread, communicate with it and stop it.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">saxon_xslt30_transform</span><span class="p">(</span>
    <span class="n">home_dir</span><span class="p">,</span> <span class="n">xml_file_name</span><span class="p">,</span> <span class="n">xsl_file_name</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="k">global</span> <span class="n">proc_globals_lock</span>

    <span class="n">input_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">output_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">SaxonPayload</span><span class="p">(</span>
        <span class="n">home_dir</span><span class="o">=</span><span class="n">home_dir</span><span class="p">,</span>
        <span class="n">xml_file_name</span><span class="o">=</span><span class="n">xml_file_name</span><span class="p">,</span>
        <span class="n">xsl_file_name</span><span class="o">=</span><span class="n">xsl_file_name</span><span class="p">,</span>
        <span class="n">output_file_name</span><span class="o">=</span><span class="n">output_file_name</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># The task event is a flag, which when:</span>
    <span class="c1"># - set: means the thread should run</span>
    <span class="c1"># - cleared: means the thread should stop and exit</span>
    <span class="n">task_event</span> <span class="o">=</span> <span class="n">ThreadEvent</span><span class="p">()</span>
    <span class="n">task_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">thread_runner</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">proc_globals_lock</span><span class="p">,</span> <span class="n">task_event</span><span class="p">,</span> <span class="n">input_queue</span><span class="p">,</span> <span class="n">output_queue</span><span class="p">),</span>
        <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># start the thread</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># give something to the thread</span>
    <span class="n">input_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="c1"># wait for the thread to react</span>
    <span class="n">input_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="c1"># wait for the thread&#39;s output</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

    <span class="c1"># kill the thread</span>
    <span class="n">task_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># adjust this to point to the directory containing you files</span>
    <span class="n">home_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;..&quot;</span> <span class="o">/</span> <span class="s2">&quot;ch3_templates&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">xml_file_name</span> <span class="o">=</span> <span class="s2">&quot;HelloWorld.xml&quot;</span>
    <span class="n">xsl_file_name</span> <span class="o">=</span> <span class="s2">&quot;HelloWorld.xsl&quot;</span>
    <span class="n">output_file_name</span> <span class="o">=</span> <span class="s2">&quot;HelloWorld.html&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">saxon_xslt30_transform</span><span class="p">(</span>
        <span class="n">home_dir</span><span class="p">,</span> <span class="n">xml_file_name</span><span class="p">,</span> <span class="n">xsl_file_name</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<h1 id="xml-schemas">XML Schemas</h1>
<h2 id="unspecified-xml-leads-to-disaster-its-a-timebomb">Unspecified XML Leads to Disaster (It's a timebomb)</h2>
<p>When you're building something with XML, it's tempting to skip creating a
schema. But what even is a schema?</p>
<p>Simply put, a schema is a formal blueprint for your XML. It’s a file you write
that defines the rules: what tags are allowed, what order they must appear in,
and what kind of data they can hold (like numbers, text, or dates).</p>
<p>It feels like extra work when you're under pressure, but using XML without a
schema is like building a complex machine without any blueprints. It might run
for a little while, but a catastrophic failure isn't just a risk—it's a
guarantee. You've essentially created a timebomb in your project. Let's break
down how it works.</p>
<ul>
<li><strong>The Bomb</strong>: Your collection of XML files. Without a schema, you don't really
  know what's inside them. You assume they follow the structure your code
  expects, but you have no guarantee.  Each file that deviates from that
  unwritten specification is a potential point of failure.</li>
<li><strong>The Ticking</strong>: Time and change. The fuse gets lit the moment your project
  needs to change. With every new software version, every new feature, or every
  data migration, the assumptions your code makes about the XML structure get
  stricter. The system gets more and more fragile with each update, and the fuse
  burns shorter.</li>
<li><strong>The Explosion</strong>: The "technical disaster." This is the moment your software
  encounters an XML document it cannot process correctly. This can manifest in
  several ways:<ul>
<li><strong>Loud Failure</strong>: The application crashes because an expected element is
  missing. This is the best-case scenario, as the problem is immediately
  obvious.</li>
<li><strong>Silent Data Corruption</strong>: The application misinterprets the data,
  leading to incorrect calculations, lost information, or corrupted
  records.  This is the most dangerous outcome, as the damage can go
  unnoticed for weeks or months, spreading through your system and making
  recovery nearly impossible.</li>
<li><strong>Massive Cleanup Effort</strong>: You are now forced to halt development,
  painstakingly analyze mountains of XML to find the inconsistencies, and
  write complex, defensive code to handle all the unexpected variations—the
  exact mess you found yourself in.</li>
</ul>
</li>
</ul>
<h2 id="a-brilliant-trap-the-saxon-give-them-enough-rope-business-model">A Brilliant Trap: The Saxon "Give Them Enough Rope" Business Model</h2>
<p>So, if this is such a common disaster, why do so many of us walk right into it?
Often, the path is paved by the very tools we start with.</p>
<p>Many of us begin our journey with XSLT using the fantastic—and free—Saxon Home
Edition (saxon-he). It's an incredibly powerful engine for transforming XML. But
there is one critical feature it intentionally leaves out: schema validation.
To get that you need to pay for a license.</p>
<p>Now, I can't say for sure if this is their grand strategic plan, but the result
is what you might call a brilliant "give them enough rope to hang themselves"
business model. Here's how it often plays out for developers:</p>
<ol>
<li>First, you get hooked on the power and elegance of XSLT using their amazing
   free tool.</li>
<li>As your project grows and evolves, you inevitably wander into the minefield
   of data inconsistency and experience the "technical disaster" we just
   described.</li>
<li>After the pain becomes too great, you realize the only way to secure
   your system is with schema validation, a feature only available in their
   licensed product line (Saxon-PE and Saxon-EE).</li>
</ol>
<p>Whether it's intentional or not, it's a powerful lesson in the true cost of
"free." This isn't just a scary story; it's a preventable outcome. Investing in
the right knowledge and tools and defining a schema from the start is your
insurance policy. It turns vague assumptions into clear, enforceable rules,
making your system stable, predictable, and much easier to evolve over time.</p>
<p>However, there are a lot of open source XML schema validation tools that you can
include in your program that you can use with the <code>sachonche</code> library.</p>
<h2 id="schema-technologies">Schema Technologies</h2>
<p>In this training we will be looking at how to integrate <strong>XDS 1.1</strong> and
<strong>Schematron</strong> schema validation technologies with Python, but here is the full
list of available schema validation technologies.</p>
<h3 id="dtd-document-type-definition">DTD (Document Type Definition)</h3>
<p>A DTD is the original schema language, introduced with the XML 1.0 specification
in 1998. Its unique offering is its simplicity and its ability to be embedded
directly within an XML file. The DTD rules can live inside a <code>&lt;!DOCTYPE
[...]&gt;</code> block at the top of the XML, making the file self-contained, or they
can be in a separate <code>.dtd</code> file that is referenced. While this reference tells a
parser what the document structure is, validation is a step that must be
explicitly enabled by the processing software, like Python's <code>lxml</code> library, which
has full support for it. DTD is a complete and stable technology, but it is
largely considered legacy because it lacks support for data types (e.g., numbers
vs. text) and namespaces. </p>
<p>The effort to learn it is <strong>very low</strong>.</p>
<h3 id="xds-10">XDS 1.0</h3>
<p>XSD 1.0 became a W3C Recommendation in 2001 as a powerful successor to DTDs. Its
unique offering is its rich set of data types (integers, dates, strings, etc.)
and full support for XML Namespaces, which are essential for complex documents.
The schema is almost always defined in a separate <code>.xsd</code> file and lives on a web
server or in the project's file system. An XML document references its schema
via an <code>xsi:schemaLocation</code> attribute in the root element. This attribute acts as
a hint; it doesn't automatically trigger validation. A validation-aware parser,
like the one included in Python's powerful <code>lxml</code> library, must be instructed to
fetch the schema and perform the validation. XSD 1.0 is a complete, stable, and
still massively widespread technology. </p>
<p>The learning effort is <strong>medium</strong> due to its verbose XML-based syntax and extensive
feature set.</p>
<h3 id="relax-ng">RELAX NG</h3>
<p>Standardized by OASIS and ISO around 2003, RELAX NG is a popular alternative to
XSD. Its unique offering is a much simpler and more intuitive grammar for
defining XML structures, especially those with complex ordering or choices. Many
find it more elegant and easier to read than XSD. The schema lives in an
external <code>.rng</code> file and can be written in either an XML syntax or a more
human-readable "compact syntax." It is typically referenced from an XML document
using a special processing instruction, and validation is performed explicitly
by a tool. Python's lxml library has excellent, built-in support for RELAX NG
validation. It is a complete and stable ISO standard that, while less widespread
than XSD, is highly respected.</p>
<p>The learning effort is <strong>medium</strong>, but generally considered lower than XSD.</p>
<h3 id="schematron">Schematron</h3>
<p>Think of Schematron not as a blueprint for your XML's structure, but as a
quality control inspector for its content. Standardized as an ISO standard in
2006, its unique purpose is <strong>to enforce specific business rules that other schema
languages can't handle</strong>. Its power comes from using XPath to make assertions. For
example, you can write a rule that says, "if an order's type attribute is
'sale', then a discount element must be present." Even better, you can define
your own clear error messages like, "Sale orders must include a discount
amount."</p>
<p>Under the hood, Schematron rules are executed by an XSLT engine. This is a
critical detail because the engine you use determines how powerful your rules
can be. Python's <code>lxml</code> library has great built-in support, but it uses an engine
limited to XPath 1.0. For more complex rules using modern features (like regular
expressions or advanced date functions), you need a more capable engine like
<code>saxonche</code>, which supports XPath 3.0 and above.</p>
<p>Your Schematron rules live in a separate <code>.sch</code> file. You apply them as a distinct
validation step, often after you've already confirmed the basic structure with
something like XSD.</p>
<p>Schematron is a complete and stable technology, and the learning effort is
<strong>medium</strong> — not because Schematron itself is complex, but because your ability to
write powerful rules depends entirely on how well you know XPath.</p>
<h3 id="xds-11">XDS 1.1</h3>
<p>Becoming a W3C Recommendation in 2012, XSD 1.1 is the modern evolution of the
XML Schema language. Its most significant unique offering is the <code>&lt;xs:assert&gt;</code>
element, which allows you to embed complex validation rules using XPath 2.0
directly inside the schema, <strong>a feature heavily inspired by Schematron</strong>. Like
its predecessor, an XSD 1.1 schema lives in an external .xsd file and is
referenced the same way. While lxml's support for 1.1 is incomplete, the Python
<code>xmlschema</code> library is the go-to tool for full XSD 1.1 support. XSD 1.1 is a
complete and stable recommendation representing the current standard. </p>
<p>The learning effort is <strong>medium-to-high</strong>, as it builds on the complexity of 1.0
with powerful new capabilities.</p>
<h2 id="xds-11-cli-and-training">XDS 1.1 CLI and Training</h2>
<p>The XDS 1.1 training examples for this repo are in <code>schema/xsd1.1/</code>. Use this
folder as your laboratory.  If you build new examples, create a schema
(<code>.xsd</code>) and a set of passing and failing xml files.  Place these examples
with the other examples in the <code>schema/xsd1.1</code> folder, then run these examples
using the <code>try check</code> command.</p>
<p>Check the help for instructions on how to use it</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>try<span class="w"> </span>check<span class="w"> </span>--help
Usage:<span class="w"> </span>try<span class="w"> </span>check<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span><span class="o">[</span>SCHEMA_FILE_NAME<span class="o">]</span>

Options:
<span class="w">  </span>-x,<span class="w"> </span>--xml<span class="w"> </span>TEXT<span class="w">  </span>Set<span class="w"> </span>the<span class="w"> </span>xml<span class="w"> </span>file
<span class="w">  </span>--help<span class="w">          </span>Show<span class="w"> </span>this<span class="w"> </span>message<span class="w"> </span>and<span class="w"> </span>exit.
</code></pre></div>

<p>Here we test a <strong>valid</strong> xml file against its xsd1.1 schema</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>-d<span class="w"> </span>schema/xsd1.1<span class="w"> </span>check<span class="w"> </span>-x<span class="w"> </span>validate_employees_1.xml<span class="w"> </span>exmployees_1.xsd
PASSED
</code></pre></div>

<p>Here we test a <strong>invalid</strong> xml file against its xsd1.1 schema</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># NOTE: The &quot;try check&quot; command caches your arguments so you don&#39;t have to type as much</span>
try<span class="w"> </span>check<span class="w"> </span>-x<span class="w"> </span>invalid_bonus_1.xml
FAILED
<span class="w"> </span>To<span class="w"> </span>implement<span class="w"> </span>your<span class="w"> </span>own<span class="w"> </span>validation<span class="w"> </span>logic,<span class="w"> </span>reference<span class="w"> </span>the<span class="w"> </span>schematron<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="k">in</span>
<span class="w"> </span>this<span class="w"> </span>repository<span class="se">\&#39;</span>s<span class="w"> </span>cli/cli.py<span class="w"> </span>file<span class="w"> </span>as<span class="w"> </span>a<span class="w"> </span>guide.<span class="w"> </span>...
</code></pre></div>

<p>Add your own examples to traing yourself.  XDS1.1 is probably enough for
validating your project, but in the case that you need to perform complex
business logic check, like ensuring math across multiple elements works as
expected, reach for schematron.</p>
<p>Once you have an example working, use professor to test you.  Example: "Given
this .xds code evaluate my understanding at TT.2, please ask 5 questions".</p>
<h2 id="schematron-cli-and-training">Schematron CLI and Training</h2>
<p>The Schematron training examples for this repo are in <code>schema/schematron/</code>.
Use this folder as your laboratory.  If you build new examples, create a schema
(<code>.sch</code>) and a set of passing and failing xml files.  Place these examples
with the other examples in the <code>schema/schematron</code> folder, then run these examples
using the <code>try check</code> command.</p>
<p>Check the help for instructions on how to use it:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>try<span class="w"> </span>check<span class="w"> </span>--help
Usage:<span class="w"> </span>try<span class="w"> </span>check<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span><span class="o">[</span>SCHEMA_FILE_NAME<span class="o">]</span>

Options:
<span class="w">  </span>-x,<span class="w"> </span>--xml<span class="w"> </span>TEXT<span class="w">  </span>Set<span class="w"> </span>the<span class="w"> </span>xml<span class="w"> </span>file
<span class="w">  </span>--help<span class="w">          </span>Show<span class="w"> </span>this<span class="w"> </span>message<span class="w"> </span>and<span class="w"> </span>exit.
</code></pre></div>

<p>Here we test a <strong>valid</strong> xml file against its xsd1.1 schema</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>-d<span class="w"> </span>schema/schematron<span class="w"> </span>check<span class="w"> </span>-x<span class="w"> </span>valid_staff_1.xml<span class="w"> </span>staff_rules_1.sch
PASSED
</code></pre></div>

<p>Here we test a <strong>invalid</strong> xml file against its xsd1.1 schema</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># NOTE: The &quot;try check&quot; command caches your arguments so you don&#39;t have to type as much</span>
try<span class="w"> </span>check<span class="w"> </span>-x<span class="w"> </span>invalid_bonus_1.xml
FAILED
&lt;?xml<span class="w"> </span><span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="w"> </span><span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="w"> </span><span class="nv">standalone</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>?&gt;
&lt;svrl:schematron-output<span class="w"> </span>xmlns:iso<span class="o">=</span><span class="s2">&quot;http://purl.oclc.org/dsdl/schematron&quot;</span>
<span class="w">                        </span>xmlns:schold<span class="o">=</span><span class="s2">&quot;http://www.ascc.net/xml/schematron&quot;</span>
<span class="w">                        </span>xmlns:svrl<span class="o">=</span><span class="s2">&quot;http://purl.oclc.org/dsdl/svrl&quot;</span>
<span class="w">                        </span>xmlns:xhtml<span class="o">=</span><span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span>
<span class="w">                        </span>xmlns:xs<span class="o">=</span><span class="s2">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>
<span class="w">                        </span><span class="nv">title</span><span class="o">=</span><span class="s2">&quot;Business Rules for Staff Roster&quot;</span>
<span class="w">                        </span><span class="nv">schemaVersion</span><span class="o">=</span><span class="s2">&quot;&quot;</span>&gt;&lt;!--<span class="w">   </span>
<span class="w">                   </span>
<span class="w">                   </span>
<span class="w">                 </span>--&gt;
<span class="w">   </span>&lt;svrl:active-pattern<span class="w"> </span><span class="nv">document</span><span class="o">=</span><span class="s2">&quot;file:///mnt/data/learning_xslt_with_python/schema/schematron/invalid_bonus_1.xml&quot;</span>
<span class="w">                        </span><span class="nv">name</span><span class="o">=</span><span class="s2">&quot;Manager and Associate Rules&quot;</span>/&gt;
<span class="w">   </span>&lt;svrl:fired-rule<span class="w"> </span><span class="nv">context</span><span class="o">=</span><span class="s2">&quot;employee[@role=&#39;associate&#39;]&quot;</span>/&gt;
<span class="w">   </span>&lt;svrl:failed-assert<span class="w"> </span><span class="nv">test</span><span class="o">=</span><span class="s2">&quot;bonus &amp;lt;= 5000&quot;</span><span class="w"> </span><span class="nv">location</span><span class="o">=</span><span class="s2">&quot;/staff/employee&quot;</span>&gt;
<span class="w">      </span>&lt;svrl:text&gt;
<span class="w">        </span>An<span class="w"> </span>associate<span class="s1">&#39;s bonus must not exceed 5000. This associate&#39;</span>s<span class="w"> </span>bonus<span class="w"> </span>is
<span class="w">        </span><span class="m">7500</span>.
<span class="w">      </span>&lt;/svrl:text&gt;
<span class="w">   </span>&lt;/svrl:failed-assert&gt;
&lt;/svrl:schematron-output&gt;
</code></pre></div>

<p>Once you have an example working, use professor to test you.  Example: "Given
this <code>.sch</code> code evaluate my understanding at TT.2, please ask 5 questions".</p>
<h2 id="xds-11-python-integration">XDS 1.1 Python Integration</h2>
<p>To access the XDS 1.1 technology install <a href="https://github.com/sissaschool/xmlschema">xmlschema</a>:</p>
<p>In this repo, the xmlschema dependency is in the setup.py file so to install it:</p>
<div class="codehilite"><pre><span></span><code>python3<span class="w"> </span>-m<span class="w"> </span>venv
<span class="nb">source</span><span class="w"> </span>venv/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
</code></pre></div>

<p>To write your own <code>xds1.1</code> parser, reference this repo's <code>cli/cli.py</code> file,
and search for <code>xmlschema</code>.</p>
<h2 id="scematron-python-integration">Scematron Python Integration</h2>
<p>To integrate schematron into your project copy the
<a href="https://github.com/Schematron/schematron/tree/master/trunk/schematron/code">schematron/trunk/schematron/code</a>
"compiler" stylesheets onto your system.  (This has been done already for this repo, so if you
have pulled this code, you have these files.)</p>
<p>The process leverages the Saxon-HE XSLT engine (via the saxonche Python library)
to enable modern XPath features. This is achieved with a two-pass transformation:</p>
<ol>
<li>Your custom <code>.sch</code> rule file is transformed by the ISO "compiler"
   stylesheets to generate a new, custom <code>.xsl</code> validator.</li>
<li>This generated <code>.xsl</code> file is used to transform your target XML data,
   producing a final SVRL (Schematron Validation Report Language) report.</li>
</ol>
<p>To implement your own validation logic, reference the <code>try check</code> subcommand
in this repository's <code>cli/cli.py</code> file as a guide.</p>
<h2 id="embracing-the-necessary-pain-of-xml-namespaces">Embracing the Necessary Pain of XML Namespaces</h2>
<p>Alright, let's wrap this schema topic up. We've been through the ringer. We've
successfully built a modern, powerful XSD1.1 and Schematron validation pipeline.
It works, it's fast, and it proves that this technology, for all its warts, is
incredibly capable.</p>
<p>And now, after all that work, I have to tell you that to do things "right," <strong>we
have to go back and break everything.</strong> It's time to talk about namespaces.</p>
<p>First, we are coming from Python, so let's not pretend this is going to be fun.
Let's commiserate and get ready for the pain by pre-listing the bullshit,
because you are going to feel it, and you should know that you're not wrong for
feeling it.</p>
<ul>
<li><strong>The Maximal Surprise Requirement</strong>: The moment you add a namespace, your
  code will break. Not with a bang, but with the silent-whimper
  of an <strong>XPath query returning an empty list for no discernible reason</strong>. The
  principle of least astonishment has been thrown out the window.</li>
<li><strong>The Abysmal Signal-to-Noise Ratio</strong>: Get ready to watch your clean, simple
  data drown in a sea of syntactic gobbledygook. Long, meaningless URLs that are
  never visited, xmlns attributes that are longer than the data itself, and
  prefixes on every single tag. It is verbose, it is tedious, and it is ugly.</li>
<li><strong>The Alien Mindset</strong>: This entire system feels hostile to a pragmatic,
  Python-centric worldview. Where Python values simplicity and readability, XML
  namespaces seem to revel in complexity and indirection. It feels like a
  solution engineered for a set of problems you don't actually have, and you're
  being forced to pay the price.</li>
</ul>
<p>So, if it's this bad, why do it? Why willingly walk into this mess?</p>
<p>Because this is the one-time, upfront payment you make to prevent a future of
catastrophic technical debt. This is the bitter medicine that makes your system
professional, scalable, and immortal.</p>
<ul>
<li><strong>Reason 1: It Makes Versioning Bulletproof.</strong> By putting the version (0.0.1,
  0.0.2, etc.) into the namespace, you create an unbreakable, unambiguous
  contract. The XML document now carries its own version identity. Your code can
  handle a v1 and a v2 document simultaneously and will never confuse them,
  because the parser sees them as fundamentally different vocabularies. It's the
  difference between labeling your files with a sticky note versus engraving the
  version number into the steel casing.</li>
<li><strong>Reason 2: It Solves the Problem You Don't Have... Yet.</strong> Right now, your
  system exists in a vacuum. But successful systems never do. The moment you
  need to integrate your <code>&lt;employee&gt;</code> data with an <code>&lt;employee&gt;</code> document
  from another department, another company, or another standard, you will face a
  name collision. Without namespaces, it's chaos. With them, <code>&lt;hr:employee&gt;</code>
  and <code>&lt;acct:employee&gt;</code> can live in the same file in perfect harmony.</li>
<li><strong>Reason 3: It's the Price of Admission.</strong> This is, for better or worse, how
  serious, interoperable data exchange is done. It's the standard. Adopting it
  is a signal that you are building a mature system designed for the long haul.</li>
</ul>
<p>So, where does this leave us?</p>
<p>It leaves us with a choice. We can take the easy path and ignore potential
future challenges, or we can adopt a more disciplined approach. The explicit
declarations, rigid rules, and added verbosity represent a shift from the "move
fast and break things" ethos of startups to a methodical and deliberate style
suited for systems that need to be stable, auditable, and durable over time.</p>
<p>It's the mindset required for building systems where precision is valued more
than convenience. Embrace it. Accept the temporary dip in productivity. Refactor
your lxml queries with namespace maps and update your Schematron rules with
<code>&lt;sch:ns&gt;</code> prefixes. You're not just writing code anymore; you're authoring a
specification.</p>
<p>If you're convinced. We can proceed with this step. But we're not approaching it
without preparation. The challenges you're about to encounter -- such as silent
failures, invisible context, and rules that may seem unclear -- can be managed
effectively. We've addressed these issues before and developed guidelines to
minimize them. This isn't theory. This is our practical guide:</p>
<ul>
<li><strong>LAW #1: We Abolished "Default" Namespaces.</strong> You will see
  <code>xmlns="urn:..."</code> in examples online. You will be tempted to use it. Do not.
  This is the source of the "maximal surprise." It creates an invisible context
  that breaks XPath and makes your life hell. <strong>All namespaces will be
  explicitly prefixed.</strong> What you see is what you get. <code>f:element</code> is good.
  <code>&lt;element&gt;</code> in a namespaced world is a landmine.</li>
<li><strong>LAW #2: We Embrace the Asymmetry.</strong> For reasons that are bizarre and
  infuriating, the XML world decided that elements should live in a namespace,
  but their attributes should not. You don't have to like it, you just have to
  obey it. This is a law of physics in our system. Your XPath for an element
  needs a prefix: <code>//f:meta</code>. Your predicate for an attribute on that element
  does not: <code>//f:meta[@version='1.0']</code>. Memorize this. It will save you hours
  of debugging.</li>
<li><strong>LAW #3: We Are Explicit in Our Code.</strong> To enforce this discipline in our
  Python code, we follow a simple, repetitive, and foolproof pattern. Every
  single function that touches XML will define and use an nsmap.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1"># Every. Single. Time. No shortcuts.</span>
<span class="n">nsmap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="s1">&#39;urn:your-fancy-namespace:v1&#39;</span><span class="p">}</span>

<span class="c1"># Use it for finding things:</span>
<span class="n">meta_element</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//f:meta&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>

<span class="c1"># Use it for creating things:</span>
<span class="n">new_element</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{urn:your-fancy-namespace:v1}data&#39;</span><span class="p">)</span> <span class="c1"># The wrong way (Clark Notation)</span>
<span class="n">new_element</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;f:data&#39;</span><span class="p">,</span> <span class="n">nsmap</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span> <span class="c1"># The right way</span>
</code></pre></div>

<p>These laws are not suggestions. They are the guidelines we developed based on
experience. They help distinguish between the frustration of debugging a complex
system and the structured, predictable approach of professional engineering.</p>
<h1 id="testing-xpath">Testing XPath</h1>
<p>Here we run an XPath expression against the <code>menu.xml</code> file in the
<code>otegem/ch03</code> directory, then cache the command:</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>-d<span class="w"> </span>./otegem/ch03<span class="w"> </span>xpath<span class="w"> </span>-x<span class="w"> </span>menus.xml<span class="w"> </span>-c<span class="w"> </span>&quot;/&quot;<span class="w"> </span>-p<span class="w"> </span>&quot;menu&quot;
context:<span class="w"> </span>/
<span class="nt">&lt;menu&gt;</span>
<span class="w">  </span><span class="nt">&lt;appetizers</span><span class="w"> </span><span class="na">title=</span><span class="s">&quot;Work up an Appetite&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;8.95&quot;</span><span class="nt">&gt;</span>Crab<span class="w"> </span>Cakes<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;9.95&quot;</span><span class="nt">&gt;</span>Jumbo<span class="w"> </span>Prawns<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;10.95&quot;</span><span class="nt">&gt;</span>Smoked<span class="w"> </span>Salmon<span class="w"> </span>and<span class="w"> </span>Avocado<span class="w"> </span>Quesadilla<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;4&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;6.95&quot;</span><span class="nt">&gt;</span>Caesar<span class="w"> </span>Salad<span class="nt">&lt;/dish&gt;</span>
<span class="w">  </span><span class="nt">&lt;/appetizers&gt;</span>
<span class="w">  </span><span class="nt">&lt;entrees</span><span class="w"> </span><span class="na">title=</span><span class="s">&quot;Chow Time!&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;5&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;19.95&quot;</span><span class="nt">&gt;</span>Grilled<span class="w"> </span>Salmon<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;6&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;17.95&quot;</span><span class="nt">&gt;</span>Seafood<span class="w"> </span>Pasta<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;7&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;16.95&quot;</span><span class="nt">&gt;</span>Linguini<span class="w"> </span>al<span class="w"> </span>Pesto<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;8&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;18.95&quot;</span><span class="nt">&gt;</span>Rack<span class="w"> </span>of<span class="w"> </span>Lamb<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;9&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;16.95&quot;</span><span class="nt">&gt;</span>Ribs<span class="w"> </span>and<span class="w"> </span>Wings<span class="nt">&lt;/dish&gt;</span>
<span class="w">  </span><span class="nt">&lt;/entrees&gt;</span>
<span class="w">  </span><span class="nt">&lt;desserts</span><span class="w"> </span><span class="na">title=</span><span class="s">&quot;To Top It Off&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;10&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;6.95&quot;</span><span class="nt">&gt;</span>Dame<span class="w"> </span>Blanche<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;11&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;5.95&quot;</span><span class="nt">&gt;</span>Chocolate<span class="w"> </span>Mousse<span class="nt">&lt;/dish&gt;</span>
<span class="w">    </span><span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;12&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;6.95&quot;</span><span class="nt">&gt;</span>Banana<span class="w"> </span>Split<span class="nt">&lt;/dish&gt;</span>
<span class="w">  </span><span class="nt">&lt;/desserts&gt;</span>
<span class="nt">&lt;/menu&gt;</span>
</code></pre></div>

<p>To run the next xpath query against the same file:</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>xpath<span class="w"> </span>-p<span class="w"> </span>&quot;(//dish)[6]&quot;
context:<span class="w"> </span>/
<span class="nt">&lt;dish</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;6&quot;</span><span class="w"> </span><span class="na">price=</span><span class="s">&quot;17.95&quot;</span><span class="nt">&gt;</span>Seafood<span class="w"> </span>Past<span class="nt">&lt;/dish&gt;</span>

try<span class="w"> </span>xpath<span class="w"> </span>-c<span class="w"> </span>&quot;/&quot;<span class="w"> </span>-p<span class="w"> </span>&quot;/menu/entrees/*/text()&quot;
context:<span class="w"> </span>/
Grilled<span class="w"> </span>Salmon
Seafood<span class="w"> </span>Pasta
Linguini<span class="w"> </span>al<span class="w"> </span>Pestro
Rack<span class="w"> </span>of<span class="w"> </span>Lamb
Ribs<span class="w"> </span>and<span class="w"> </span>Wings
</code></pre></div>

<p>You would use the context to simulate how a template matching an XPath pattern
would behave.  Suppose you were trying to see what line 12 of the following
would output:</p>
<div class="codehilite"><pre><span></span><code><span class="w"> </span>1<span class="w">  </span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="w"> </span>2<span class="w">  </span><span class="k">&lt;xsl:stylesheet</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;1.0&quot;</span>
<span class="w"> </span><span class="err">3</span><span class="w">   </span><span class="na">xmlns:xsl=</span><span class="s">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span><span class="nt">&gt;</span>
<span class="w"> </span>4<span class="w">    </span><span class="nt">&lt;xsl:</span><span class="w"> </span><span class="err">tempate</span><span class="w"> </span><span class="na">match=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>
<span class="w"> </span>5<span class="w">      </span><span class="k">&lt;xsl:apply-templates</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w"> </span>6<span class="w">    </span><span class="k">&lt;/xsl:template&gt;</span>
<span class="w"> </span>7<span class="w">    </span><span class="nt">&lt;xsl:</span><span class="w"> </span><span class="err">tempate</span><span class="w"> </span><span class="na">match=</span><span class="s">&quot;/menu/entrees&quot;</span><span class="nt">&gt;</span>
<span class="w"> </span>8<span class="w">      </span>Entrees:
<span class="w"> </span>9<span class="w">      </span><span class="k">&lt;xsl:apply-templates</span><span class="w"> </span><span class="nt">/&gt;</span>
10<span class="w">    </span><span class="k">&lt;/xsl:template&gt;</span>
11<span class="w">    </span><span class="k">&lt;xsl:template</span><span class="w"> </span><span class="na">match=</span><span class="s">&quot;dish&quot;</span><span class="nt">&gt;</span>
12<span class="w">      </span><span class="k">&lt;xsl:value-of</span><span class="w"> </span><span class="na">select=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
13<span class="w">    </span><span class="k">&lt;/xsl:template&gt;</span>
13<span class="w">  </span><span class="k">&lt;/xsl:stylesheet&gt;</span>
</code></pre></div>

<p>We could simulate what would be expressed at line 12 by setting the context to
<code>/menu/entrees</code>:</p>
<div class="codehilite"><pre><span></span><code>try xpath -v
3.1

try xpath -c &quot;/menu/entrees&quot; -p &quot;dish/text()[1]&quot;
context: /menu/entrees
Grilled Salmon
</code></pre></div>

<h1 id="testing-xpath-axis-features">Testing XPath Axis Features</h1>
<p>This picture will help you understand how the axis feature works in XPath:</p>
<p><img alt="xpath 2" src="patterns/xpath_2.svg" /></p>
<p>This is how the above picture can be represented in XML (see <code>patterns/axis_testing.xml</code>):</p>
<div class="codehilite"><pre><span></span><code>try<span class="w"> </span>-d<span class="w"> </span>patterns/<span class="w"> </span>xpath<span class="w"> </span>-x&quot;axis_testing.xml&quot;<span class="w"> </span>-c&quot;/&quot;<span class="w"> </span>-p&quot;*&quot;
context:<span class="w"> </span>/
<span class="nt">&lt;A</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;B</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;C</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;3&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;D</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;4&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;E</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;5&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;H</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;8&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;M</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;13&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;/H&gt;</span>
<span class="w">      </span><span class="nt">&lt;I</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;9&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;J</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;10&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;N</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;14&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;O</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;15&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;T</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;20&quot;</span><span class="nt">/&gt;</span>
<span class="w">          </span><span class="nt">&lt;U</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;21&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/O&gt;</span>
<span class="w">        </span><span class="nt">&lt;P</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;16&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;Q</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;17&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;R</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;18&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;V</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;22&quot;</span><span class="nt">/&gt;</span>
<span class="w">          </span><span class="nt">&lt;W</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;23&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/R&gt;</span>
<span class="w">      </span><span class="nt">&lt;/J&gt;</span>
<span class="w">      </span><span class="nt">&lt;K</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;11&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;L</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;12&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;S</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;19&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;/L&gt;</span>
<span class="w">    </span><span class="nt">&lt;/E&gt;</span>
<span class="w">    </span><span class="nt">&lt;F</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;6&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;G</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;7&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/B&gt;</span>
<span class="nt">&lt;/A&gt;</span>
</code></pre></div>

<p>Now let's set <code>J</code> as the node context and perform our first axis experiment:</p>
<div class="codehilite"><pre><span></span><code>try xpath -c &quot;//J&quot; -p &quot;self::*/name()&quot;
context: //J
J
</code></pre></div>

<p>Let's look to see how the <code>following::</code> axis works, we search the "following" axis for any node name (<code>*</code>) 
and return the matched node names:</p>
<div class="codehilite"><pre><span></span><code>try xpath -p &quot;following::*/name()&quot;
&quot;K&quot;
&quot;L&quot;
&quot;S&quot;
&quot;F&quot;
&quot;G&quot;

try xpath -p &quot;(following::* union preceding::*)/name()&quot;
&quot;C&quot;
&quot;D&quot;
&quot;H&quot;
&quot;M&quot;
&quot;I&quot;
&quot;K&quot;
&quot;L&quot;
&quot;S&quot;
&quot;F&quot;
&quot;G&quot;
</code></pre></div>

<blockquote>
<p><strong>Note</strong>
If you are parsing an <code>xhtml</code> doc include the <code>xhtml</code> namespace prefix in your query:
<code>try -d oneal xpath -x example.html -c "/" -p "//xhtml:h1[1]"</code></p>
</blockquote>
<h1 id="prototyping-your-xsltxpath-code-in-python">Prototyping your XSLT/XPATH code in Python</h1>
<p>The <code>try to-python</code> writes boilerplate code for you.  You would use this
command to:</p>
<ul>
<li>convert an XML file into a python dict within a minimal python program</li>
<li>extend this generated python program with recursive expressions to solve your
  problem. (like an XSLT program would solve your problem)</li>
<li>debug this python program using python tools</li>
<li>place the working recursive python program into ChatGPT to discover XSLT syntax that will
  do the same thing</li>
<li>use the recursive styled python, and the broken ChatGPT examples as a set of
  mental blueprints for how to write your XSLT program.</li>
<li>write out your XSLT referencing these examples</li>
<li>debug your XSLT until it works.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">try -d patterns to-python -x axis_testing.xml -o axis_testing.py -v</span>
<span class="c"># some python code written to the terminal</span>
</code></pre></div>

<p>This command will output this python program:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pp</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;3&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;4&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;8&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;13&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;9&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;J&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;10&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;14&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;15&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;20&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;21&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;16&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;17&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;18&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;22&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;23&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;11&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;12&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;19&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;6&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;@id&quot;</span> <span class="p">:</span><span class="s2">&quot;7&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">pp</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</code></pre></div>

<p>If you run this program you will see this in your terminal:</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">patterns</span><span class="o">/</span><span class="n">axis_testing</span><span class="p">.</span><span class="n">py</span>
<span class="err">{</span><span class="s1">&#39;A&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
<span class="w">       </span><span class="s1">&#39;B&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;C&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;D&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;4&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;E&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="p">,</span>
<span class="w">                   </span><span class="s1">&#39;H&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;M&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;13&#39;</span><span class="err">}}</span><span class="p">,</span>
<span class="w">                   </span><span class="s1">&#39;I&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;9&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">                   </span><span class="s1">&#39;J&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;10&#39;</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;N&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;14&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;O&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;15&#39;</span><span class="p">,</span>
<span class="w">                               </span><span class="s1">&#39;T&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;20&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">                               </span><span class="s1">&#39;U&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;21&#39;</span><span class="err">}}</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;P&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;16&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;Q&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;17&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;R&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;18&#39;</span><span class="p">,</span>
<span class="w">                               </span><span class="s1">&#39;V&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;22&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">                               </span><span class="s1">&#39;W&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;23&#39;</span><span class="err">}}}</span><span class="p">,</span>
<span class="w">                   </span><span class="s1">&#39;K&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;11&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">                   </span><span class="s1">&#39;L&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;12&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;S&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;19&#39;</span><span class="err">}}}</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;F&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;6&#39;</span><span class="err">}</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;G&#39;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;@id&#39;</span><span class="err">:</span><span class="w"> </span><span class="s1">&#39;7&#39;</span><span class="err">}}}}</span>
</code></pre></div>

<h1 id="useful-links">Useful links</h1>
<ul>
<li><a href="https://www.saxonica.com/saxon-c/documentation12/index.html#!samples/samples_python">Broken python examples from Saxonica</a></li>
<li><a href="https://www.youtube.com/watch?v=2Zt9oJtFKGw">interview with Michael Kay</a></li>
<li><a href="https://www.altova.com/training/xpath3">XPath 3.0/3.1 training resource</a>,</li>
<li><a href="https://github.com/evanlenz/xslt-visualizer">XSLT-visualizer</a></li>
<li><a href="https://github.com/Saxonica/Prague2016">XSLT 3.0 Prague 2016 resources</a></li>
<li><a href="https://www.youtube.com/watch?v=WggVR4YI5oI">XSLT XPath Tutorial by arbitrarytechnology</a></li>
<li><a href="https://www.saxonica.com/papers/xmlprague-2016mhk.pdf">Saxon XSLT 3.0 JSON Whitepaper</a></li>
<li><a href="http://dh.obdurodon.org/xslt3.xhtml">What's new in XSLT 3.0 and XPath 3.1</a></li>
<li><a href="https://www.videlibri.de/xidel.html">xidel: Xidel is a command line tool to download and extract data from HTML/XML pages as well as JSON APIs</a></li>
<li><a href="http://dh.obdurodon.org/">XML/XSLT links on Digital humanities</a></li>
<li><a href="https://www.saxonica.com/documentation12/#!xsl-elements">XSLT elements</a></li>
<li><a href="https://stackoverflow.com/a/48051099">Martin Honnen's Understanding how to use maps</a></li>
<li><a href="https://xslt-3-by-example.blogspot.com/">Martin Honnen's XSLT 3.0 by example blog</a></li>
<li><a href="https://gist.github.com/martin-honnen">Martin Honnen's XSLT github gists</a></li>
<li><a href="https://www.w3.org/TR/xslt-30">XSL 3.0 Specification</a></li>
<li><a href="https://realpython.com/python-xml-parser/">A Roadmap to XML Parsers in Python</a></li>
<li><a href="https://pypi.org/project/xmlschema/">xmlschema python package</a></li>
</ul>
    </article>
</body>
</html>
